{% extends "admin/base_admin.html" %}

{% block title %}Manage Abstracts{% endblock %}

{% block admin_content %}
<div class="container py-5">

  <!-- Header -->
  <div class="row mb-4">
    <div class="col-md-8">
      <h2 class="mb-0">
        <i class="fas fa-file-alt text-primary me-2"></i>Abstract Submissions
      </h2>
      <p class="text-muted mb-0">Manage and review all abstracts</p>
    </div>
    <div class="col-md-4 text-end">
      <a id="exportCsvBtn" href="{% url 'conference:ncps_admin:export_abstracts' %}" class="btn btn-polar rounded-pill">
        <i class="fas fa-download me-1"></i> Export CSV
      </a>
    </div>
  </div>

  <!-- Search and Filter -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <input type="text"
                 id="searchInput"
                 class="form-control"
                 placeholder="ðŸ” Search by title, user, code or ID..." value="{{ search_query }}">
        </div>
        <div class="col-md-3">
          <select id="statusFilter" class="form-select">
            <option value="">All Status</option>
            <option value="PENDING" {% if current_status == 'PENDING' %}selected{% endif %}>Pending</option>
            <option value="APPROVED" {% if current_status == 'APPROVED' %}selected{% endif %}>Approved</option>
            <option value="REJECTED" {% if current_status == 'REJECTED' %}selected{% endif %}>Rejected</option>
            <option value="REVISION" {% if current_status == 'REVISION' %}selected{% endif %}>Revision Required</option>
          </select>
        </div>
        <div class="col-md-3">
          <select id="themeFilter" class="form-select">
            <option value="">All Themes</option>
            {% for t in themes %}
            <option value="{{ t.code }}" {% if current_theme == t.code %}selected{% endif %}>{{ t.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
            <i class="fas fa-redo me-1"></i> Clear
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="abstractsTable">
          <thead class="table-light">
            <tr>
              <th class="sortable" data-sort="id" data-default-sort="asc">
                ID <i class="fas fa-sort text-muted"></i>
              </th>
              <th class="sortable" data-sort="title">
                Title <i class="fas fa-sort text-muted"></i>
              </th>
              <th class="sortable" data-sort="user">
                User <i class="fas fa-sort text-muted"></i>
              </th>
              <th>Code</th>
              <th>Theme</th>
              <th class="sortable" data-sort="status">
                Status <i class="fas fa-sort text-muted"></i>
              </th>
              <th class="sortable" data-sort="date">
                Submitted <i class="fas fa-sort text-muted"></i>
              </th>
              <th></th>
            </tr>
          </thead>
            <tbody id="abstractsTableBody">
            {% for abstract in abstracts %}
            <tr data-id="{{ abstract.id }}"
              data-code="{{ abstract.user.participant.participant_code|default:'' }}"
              data-title="{{ abstract.title|lower }}"
              data-user="{{ abstract.user.username|lower }}"
              data-status="{{ abstract.status }}"
              data-theme="{% if abstract.theme %}{{ abstract.theme.code }}{% endif %}">
              <td>{{ abstract.id }}</td>
              <td>{{ abstract.title }}</td>
              <td>{{ abstract.user.username }}</td>
              <td><strong>{{ abstract.user.participant.participant_code|default:"-" }}</strong></td>
              <td>
                {% if abstract.theme %}
                  {{ abstract.theme.name }}
                {% else %}
                  {{ abstract.scientific_theme|default:"-" }}
                {% endif %}
              </td>
              <td>
                <span class="badge 
                  {% if abstract.status == 'approved' %}bg-success
                  {% elif abstract.status == 'rejected' %}bg-danger
                  {% else %}bg-secondary{% endif %}">
                  {{ abstract.get_status_display }}
                </span>
              </td>
              <td>{{ abstract.submitted_at|date:"d M Y" }}</td>
              <td>
                <a href="{% url 'conference:ncps_admin:abstract_detail' abstract.id %}"
                   class="btn btn-sm btn-outline-polar">
                  <i class="fas fa-eye"></i>
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center py-4 text-muted">
                No abstracts found
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<style>
.sortable {
  cursor: pointer;
  user-select: none;
}
.sortable:hover {
  background-color: #f0f0f0;
}
.sortable i {
  font-size: 0.8em;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('searchInput');
  const statusFilter = document.getElementById('statusFilter');
  const themeFilter = document.getElementById('themeFilter');
  const tableBody = document.getElementById('abstractsTableBody');
  const allRows = Array.from(tableBody.querySelectorAll('tr[data-id]'));
  
  let currentSort = { column: null, ascending: true };

  // Live search
  searchInput.addEventListener('input', filterTable);
  statusFilter.addEventListener('change', filterTable);
  if (themeFilter) themeFilter.addEventListener('change', onThemeChange);

  function filterTable() {
    const searchTerm = searchInput.value.toLowerCase();
    const statusValue = statusFilter.value;
    const themeValue = themeFilter ? themeFilter.value : '';
    
    let visibleCount = 0;
    allRows.forEach(row => {
      const id = row.dataset.id;
      const code = (row.dataset.code || '').toLowerCase();
      const title = row.dataset.title;
      const user = row.dataset.user;
      const status = row.dataset.status;
      const theme = row.dataset.theme || '';

      const matchesSearch = !searchTerm ||
        id.includes(searchTerm) ||
        title.includes(searchTerm) ||
        user.includes(searchTerm) ||
        code.includes(searchTerm);
      
      const matchesStatus = !statusValue || status === statusValue;
      const matchesTheme = !themeValue || theme === themeValue;
      
      if (matchesSearch && matchesStatus && matchesTheme) {
        row.style.display = '';
        visibleCount++;
      } else {
        row.style.display = 'none';
      }
    });
    
    // Update empty state
    updateEmptyState(visibleCount);
    // Keep export URL in sync with current client-side filters
    updateExportHref();
  }

  function onThemeChange() {
    // When theme selected, reload server-side filtered list to handle large datasets.
    const theme = themeFilter.value;
    const params = new URLSearchParams(window.location.search);
    if (theme) params.set('theme', theme); else params.delete('theme');
    // Preserve status and search in query params as well
    if (statusFilter.value) params.set('status', statusFilter.value); else params.delete('status');
    if (searchInput.value) params.set('search', searchInput.value); else params.delete('search');
    window.location = window.location.pathname + '?' + params.toString();
  }

  // Update export button href to include current filters
  function updateExportHref() {
    const exportBtn = document.getElementById('exportCsvBtn');
    if (!exportBtn) return;
    const params = new URLSearchParams(window.location.search);
    if (searchInput && searchInput.value) params.set('search', searchInput.value);
    else params.delete('search');
    if (statusFilter && statusFilter.value) params.set('status', statusFilter.value);
    else params.delete('status');
    if (themeFilter && themeFilter.value) params.set('theme', themeFilter.value);
    else params.delete('theme');
    const baseExport = exportBtn.getAttribute('href').split('?')[0];
    exportBtn.href = baseExport + (params.toString() ? ('?' + params.toString()) : '');
  }

  function updateEmptyState(count) {
    let emptyRow = tableBody.querySelector('tr.empty-row');
    if (count === 0 && !emptyRow) {
      emptyRow = document.createElement('tr');
      emptyRow.className = 'empty-row';
      emptyRow.innerHTML = '<td colspan="7" class="text-center py-4 text-muted">No matching abstracts found</td>';
      tableBody.appendChild(emptyRow);
    } else if (count > 0 && emptyRow) {
      emptyRow.remove();
    }
  }

  // Sorting
  document.querySelectorAll('.sortable').forEach(header => {
    header.addEventListener('click', function() {
      const sortBy = this.dataset.sort;
      sortTable(sortBy);
      updateSortIcons(this);
    });
  });

  function sortTable(column) {
    if (currentSort.column === column) {
      currentSort.ascending = !currentSort.ascending;
    } else {
      // New column clicked: use its default-sort (asc/desc) if provided
      const headerEl = document.querySelector(`.sortable[data-sort="${column}"]`);
      const defaultSort = headerEl && headerEl.dataset && headerEl.dataset.defaultSort ? headerEl.dataset.defaultSort.toLowerCase() : 'asc';
      currentSort.column = column;
      currentSort.ascending = (defaultSort === 'asc');
    }

    const sortedRows = allRows.sort((a, b) => {
      let valA, valB;
      
      switch(column) {
        case 'id':
          valA = parseInt(a.dataset.id);
          valB = parseInt(b.dataset.id);
          break;
        case 'title':
          valA = a.dataset.title;
          valB = b.dataset.title;
          break;
        case 'user':
          valA = a.dataset.user;
          valB = b.dataset.user;
          break;
        case 'status':
          valA = a.dataset.status;
          valB = b.dataset.status;
          break;
        case 'date':
            // Submitted date is in the 6th column (0-based index 5)
            valA = a.children[5].textContent;
            valB = b.children[5].textContent;
          break;
      }
      
      if (valA < valB) return currentSort.ascending ? -1 : 1;
      if (valA > valB) return currentSort.ascending ? 1 : -1;
      return 0;
    });

    // Re-append rows in sorted order
    sortedRows.forEach(row => tableBody.appendChild(row));
    
    // Keep empty row at end if it exists
    const emptyRow = tableBody.querySelector('tr:not([data-id])');
    if (emptyRow) {
      tableBody.appendChild(emptyRow);
    }
  }

  function updateSortIcons(activeHeader) {
    document.querySelectorAll('.sortable i').forEach(icon => {
      icon.className = 'fas fa-sort text-muted';
    });
    
    const icon = activeHeader.querySelector('i');
    icon.className = currentSort.ascending ? 
      'fas fa-sort-up text-primary' : 
      'fas fa-sort-down text-primary';
  }

  window.clearFilters = function() {
    searchInput.value = '';
    statusFilter.value = '';
    filterTable();
  };
  // Default sort on page load: ID ascending (1..N)
  try {
    sortTable('id');
    const idHeader = document.querySelector('.sortable[data-sort="id"]');
    if (idHeader) updateSortIcons(idHeader);
  } catch (e) {
    // no-op if sorting fails
    console.warn('Default sort failed', e);
  }

  // Initialize export href on load
  updateExportHref();
});
</script>
{% endblock %}
